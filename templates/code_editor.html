{% extends 'layout.html' %}

{% block title %}Synapse Chamber - Code Editor{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
<style>
    /* Editor Layout */
    .editor-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 56px - 2rem);
        background-color: #1e1e1e;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background-color: #252526;
        border-bottom: 1px solid #3e3e42;
    }
    
    .editor-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .editor-title-text {
        font-weight: 500;
        color: #e0e0e0;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .editor-modified-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #3794ff;
        display: none;
    }
    
    .editor-modified .editor-modified-indicator {
        display: block;
    }
    
    .editor-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .editor-main {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    
    .editor-sidebar {
        width: 250px;
        border-right: 1px solid #3e3e42;
        display: flex;
        flex-direction: column;
        background-color: #252526;
    }
    
    .editor-sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #3e3e42;
    }
    
    .editor-sidebar-title {
        font-weight: 500;
        font-size: 0.875rem;
        color: #e0e0e0;
    }
    
    .editor-sidebar-content {
        flex: 1;
        overflow-y: auto;
    }
    
    .editor-content {
        flex: 1;
        overflow: hidden;
    }
    
    #monaco-editor-container {
        width: 100%;
        height: 100%;
    }
    
    .editor-footer {
        padding: 0.25rem 1rem;
        background-color: #007acc;
        color: white;
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
    }
    
    .editor-info {
        display: flex;
        gap: 1rem;
    }
    
    .editor-status {
        display: flex;
        gap: 1rem;
    }
    
    /* File Explorer */
    .file-explorer {
        height: 100%;
        overflow-y: auto;
        padding: 0.5rem 0;
    }
    
    .file-explorer::-webkit-scrollbar {
        width: 6px;
    }
    
    .file-explorer::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .file-explorer::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 3px;
    }
    
    .file-explorer::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.25);
    }
    
    .folder-item {
        padding: 0.25rem 0;
    }
    
    .folder-header {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        cursor: pointer;
        user-select: none;
    }
    
    .folder-header:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .folder-icon {
        margin-right: 0.5rem;
        width: 16px;
        text-align: center;
    }
    
    .folder-name {
        flex: 1;
        font-size: 0.875rem;
        color: #e0e0e0;
    }
    
    .folder-content {
        padding-left: 1.5rem;
    }
    
    .folder-collapsed .folder-content {
        display: none;
    }
    
    .folder-collapsed .folder-icon .fa-folder-open {
        display: none;
    }
    
    .folder-collapsed .folder-icon .fa-folder {
        display: inline;
    }
    
    .folder-expanded .folder-icon .fa-folder-open {
        display: inline;
    }
    
    .folder-expanded .folder-icon .fa-folder {
        display: none;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        cursor: pointer;
        user-select: none;
    }
    
    .file-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .file-item.active {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .file-icon {
        margin-right: 0.5rem;
        width: 16px;
        text-align: center;
        color: #75beff;
    }
    
    .file-icon.python {
        color: #4b8bbe;
    }
    
    .file-icon.javascript {
        color: #f0db4f;
    }
    
    .file-icon.html {
        color: #e34c26;
    }
    
    .file-icon.css {
        color: #264de4;
    }
    
    .file-icon.json {
        color: #f0c674;
    }
    
    .file-icon.markdown {
        color: #b294bb;
    }
    
    .file-name {
        font-size: 0.875rem;
        color: #e0e0e0;
    }
    
    /* Tabs */
    .editor-tabs {
        display: flex;
        background-color: #2d2d2d;
        border-bottom: 1px solid #3e3e42;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .editor-tabs::-webkit-scrollbar {
        height: 5px;
    }
    
    .editor-tabs::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .editor-tabs::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 3px;
    }
    
    .editor-tabs::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.25);
    }
    
    .editor-tab {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-right: 1px solid #3e3e42;
        cursor: pointer;
        background-color: #2d2d2d;
        color: #cccccc;
        position: relative;
        max-width: 200px;
    }
    
    .editor-tab.active {
        background-color: #1e1e1e;
        color: #ffffff;
    }
    
    .editor-tab.active::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #007acc;
    }
    
    .editor-tab-icon {
        margin-right: 0.5rem;
        font-size: 0.875rem;
    }
    
    .editor-tab-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .editor-tab-close {
        margin-left: 0.5rem;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
    }
    
    .editor-tab-close:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .editor-tab-modified {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #3794ff;
        margin-left: 0.5rem;
        display: none;
    }
    
    .editor-tab.modified .editor-tab-modified {
        display: block;
    }
    
    .editor-tab.modified .editor-tab-close {
        display: none;
    }
    
    .editor-tab.modified:hover .editor-tab-modified {
        display: none;
    }
    
    .editor-tab.modified:hover .editor-tab-close {
        display: flex;
    }
    
    /* Terminal */
    .editor-terminal {
        height: 200px;
        background-color: #1e1e1e;
        border-top: 1px solid #3e3e42;
        overflow: hidden;
        display: none;
    }
    
    .editor-terminal.open {
        display: block;
    }
    
    .terminal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0.5rem;
        background-color: #252526;
        border-bottom: 1px solid #3e3e42;
    }
    
    .terminal-tabs {
        display: flex;
    }
    
    .terminal-tab {
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        cursor: pointer;
        color: #cccccc;
        border-right: 1px solid #3e3e42;
    }
    
    .terminal-tab.active {
        background-color: #1e1e1e;
        color: #ffffff;
    }
    
    .terminal-actions {
        display: flex;
    }
    
    .terminal-content {
        height: calc(100% - 31px);
        overflow: auto;
        padding: 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        color: #e0e0e0;
    }
    
    /* Context Menu */
    .context-menu {
        position: absolute;
        background-color: #252526;
        border: 1px solid #3e3e42;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        padding: 0.25rem 0;
        min-width: 180px;
        z-index: 1000;
    }
    
    .context-menu-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    
    .context-menu-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .context-menu-icon {
        width: 16px;
        margin-right: 0.5rem;
        text-align: center;
    }
    
    .context-menu-separator {
        height: 1px;
        background-color: #3e3e42;
        margin: 0.25rem 0;
    }
    
    /* Monaco Editor Overrides */
    .monaco-editor .monaco-editor-background,
    .monaco-editor .margin-view-overlays {
        background-color: #1e1e1e !important;
    }
    
    /* Dialog */
    .editor-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .editor-dialog-content {
        background-color: #252526;
        border-radius: 6px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        width: 400px;
        max-width: 90%;
    }
    
    .editor-dialog-header {
        padding: 1rem;
        border-bottom: 1px solid #3e3e42;
    }
    
    .editor-dialog-title {
        font-size: 1.125rem;
        font-weight: 500;
        color: #e0e0e0;
        margin: 0;
    }
    
    .editor-dialog-body {
        padding: 1rem;
    }
    
    .editor-dialog-footer {
        padding: 1rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        border-top: 1px solid #3e3e42;
    }
    
    /* Custom Scrollbar for all elements */
    *::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    *::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }
    
    *::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 3px;
    }
    
    *::-webkit-scrollbar-thumb:hover {
        background-color: rgba(255, 255, 255, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="editor-header">
        <div class="editor-title">
            <div class="editor-modified-indicator"></div>
            <div class="editor-title-text">Synapse Chamber Code Editor</div>
        </div>
        <div class="editor-actions">
            <button class="btn btn-sm btn-outline-secondary" id="newFileBtn" title="New File">
                <i class="fas fa-file"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="saveFileBtn" title="Save File">
                <i class="fas fa-save"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="runFileBtn" title="Run File">
                <i class="fas fa-play"></i>
            </button>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="editorMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="editorMenuBtn">
                    <li><a class="dropdown-item" href="#" id="toggleTerminalBtn"><i class="fas fa-terminal me-2"></i> Toggle Terminal</a></li>
                    <li><a class="dropdown-item" href="#" id="toggleSidebarBtn"><i class="fas fa-columns me-2"></i> Toggle Sidebar</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="formatCodeBtn"><i class="fas fa-indent me-2"></i> Format Code</a></li>
                    <li><a class="dropdown-item" href="#" id="findReplaceBtn"><i class="fas fa-search me-2"></i> Find/Replace</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" id="editorSettingsBtn"><i class="fas fa-cog me-2"></i> Editor Settings</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="editor-main">
        <div class="editor-sidebar">
            <div class="editor-sidebar-header">
                <div class="editor-sidebar-title">EXPLORER</div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" id="newFolderBtn" title="New Folder">
                        <i class="fas fa-folder-plus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="refreshExplorerBtn" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="editor-sidebar-content">
                <div class="file-explorer" id="fileExplorer">
                    <!-- File explorer content will be populated dynamically -->
                    <div class="folder-item folder-expanded">
                        <div class="folder-header">
                            <div class="folder-icon">
                                <i class="fas fa-folder-open"></i>
                                <i class="fas fa-folder" style="display: none;"></i>
                            </div>
                            <div class="folder-name">synapse_chamber</div>
                        </div>
                        <div class="folder-content">
                            <div class="folder-item folder-expanded">
                                <div class="folder-header">
                                    <div class="folder-icon">
                                        <i class="fas fa-folder-open"></i>
                                        <i class="fas fa-folder" style="display: none;"></i>
                                    </div>
                                    <div class="folder-name">templates</div>
                                </div>
                                <div class="folder-content">
                                    <div class="file-item">
                                        <div class="file-icon html">
                                            <i class="fab fa-html5"></i>
                                        </div>
                                        <div class="file-name">layout.html</div>
                                    </div>
                                    <div class="file-item">
                                        <div class="file-icon html">
                                            <i class="fab fa-html5"></i>
                                        </div>
                                        <div class="file-name">terminal.html</div>
                                    </div>
                                    <div class="file-item">
                                        <div class="file-icon html">
                                            <i class="fab fa-html5"></i>
                                        </div>
                                        <div class="file-name">memory_explorer.html</div>
                                    </div>
                                </div>
                            </div>
                            <div class="folder-item folder-expanded">
                                <div class="folder-header">
                                    <div class="folder-icon">
                                        <i class="fas fa-folder-open"></i>
                                        <i class="fas fa-folder" style="display: none;"></i>
                                    </div>
                                    <div class="folder-name">static</div>
                                </div>
                                <div class="folder-content">
                                    <div class="folder-item folder-collapsed">
                                        <div class="folder-header">
                                            <div class="folder-icon">
                                                <i class="fas fa-folder-open" style="display: none;"></i>
                                                <i class="fas fa-folder"></i>
                                            </div>
                                            <div class="folder-name">css</div>
                                        </div>
                                        <div class="folder-content">
                                            <!-- content hidden due to collapsed state -->
                                        </div>
                                    </div>
                                    <div class="folder-item folder-collapsed">
                                        <div class="folder-header">
                                            <div class="folder-icon">
                                                <i class="fas fa-folder-open" style="display: none;"></i>
                                                <i class="fas fa-folder"></i>
                                            </div>
                                            <div class="folder-name">js</div>
                                        </div>
                                        <div class="folder-content">
                                            <!-- content hidden due to collapsed state -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="file-item active">
                                <div class="file-icon python">
                                    <i class="fab fa-python"></i>
                                </div>
                                <div class="file-name">main.py</div>
                            </div>
                            <div class="file-item">
                                <div class="file-icon python">
                                    <i class="fab fa-python"></i>
                                </div>
                                <div class="file-name">advanced_memory_system.py</div>
                            </div>
                            <div class="file-item">
                                <div class="file-icon python">
                                    <i class="fab fa-python"></i>
                                </div>
                                <div class="file-name">agent_system.py</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="editor-content">
            <div class="editor-tabs">
                <div class="editor-tab active">
                    <div class="editor-tab-icon">
                        <i class="fab fa-python"></i>
                    </div>
                    <div class="editor-tab-name">main.py</div>
                    <div class="editor-tab-modified"></div>
                    <div class="editor-tab-close">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="editor-tab">
                    <div class="editor-tab-icon">
                        <i class="fab fa-python"></i>
                    </div>
                    <div class="editor-tab-name">advanced_memory_system.py</div>
                    <div class="editor-tab-modified"></div>
                    <div class="editor-tab-close">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            </div>
            <div id="monaco-editor-container"></div>
        </div>
    </div>
    
    <div class="editor-terminal">
        <div class="terminal-header">
            <div class="terminal-tabs">
                <div class="terminal-tab active">Terminal</div>
                <div class="terminal-tab">Output</div>
                <div class="terminal-tab">Problems</div>
            </div>
            <div class="terminal-actions">
                <button class="btn btn-sm btn-outline-secondary" id="clearTerminalBtn" title="Clear Terminal">
                    <i class="fas fa-eraser"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="closeTerminalBtn" title="Close Terminal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="terminal-content" id="terminalContent">
            <div>Python 3.11.4 (Nov 15 2024, 10:32:15)</div>
            <div>[GCC 9.4.0] on linux</div>
            <div>Type "help", "copyright", "credits" or "license" for more information.</div>
            <div>&gt;&gt;&gt; from app import app</div>
            <div>&gt;&gt;&gt; app.name</div>
            <div>'synapse_chamber'</div>
            <div>&gt;&gt;&gt; _</div>
        </div>
    </div>
    
    <div class="editor-footer">
        <div class="editor-info">
            <div>Python</div>
            <div>UTF-8</div>
            <div>LF</div>
        </div>
        <div class="editor-status">
            <div>Ln 1, Col 1</div>
            <div>Spaces: 4</div>
        </div>
    </div>
</div>

<!-- Context Menu (Hidden by Default) -->
<div class="context-menu" id="contextMenu" style="display: none;">
    <div class="context-menu-item" id="contextMenuNewFile">
        <div class="context-menu-icon"><i class="fas fa-file"></i></div>
        New File
    </div>
    <div class="context-menu-item" id="contextMenuNewFolder">
        <div class="context-menu-icon"><i class="fas fa-folder-plus"></i></div>
        New Folder
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" id="contextMenuCopy">
        <div class="context-menu-icon"><i class="fas fa-copy"></i></div>
        Copy
    </div>
    <div class="context-menu-item" id="contextMenuCut">
        <div class="context-menu-icon"><i class="fas fa-cut"></i></div>
        Cut
    </div>
    <div class="context-menu-item" id="contextMenuPaste">
        <div class="context-menu-icon"><i class="fas fa-paste"></i></div>
        Paste
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" id="contextMenuRename">
        <div class="context-menu-icon"><i class="fas fa-pen"></i></div>
        Rename
    </div>
    <div class="context-menu-item" id="contextMenuDelete">
        <div class="context-menu-icon"><i class="fas fa-trash"></i></div>
        Delete
    </div>
</div>

<!-- New File Dialog (Hidden by Default) -->
<div class="editor-dialog" id="newFileDialog" style="display: none;">
    <div class="editor-dialog-content">
        <div class="editor-dialog-header">
            <h5 class="editor-dialog-title">New File</h5>
        </div>
        <div class="editor-dialog-body">
            <div class="mb-3">
                <label for="newFileName" class="form-label">File Name</label>
                <input type="text" class="form-control" id="newFileName" placeholder="Enter file name">
                <div class="form-text">Enter file name with extension (e.g., script.py)</div>
            </div>
        </div>
        <div class="editor-dialog-footer">
            <button type="button" class="btn btn-secondary" id="cancelNewFileBtn">Cancel</button>
            <button type="button" class="btn btn-primary" id="createNewFileBtn">Create</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Monaco Editor -->
<script>
    // This is a dummy loader that will only work when Monaco is loaded externally
    var require = { paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.nls.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Monaco Editor
    const editorContainer = document.getElementById('monaco-editor-container');
    
    // Sample code (python)
    const sampleCode = `from app import app

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
`;
    
    // Initialize editor
    const editor = monaco.editor.create(editorContainer, {
        value: sampleCode,
        language: 'python',
        theme: 'vs-dark',
        automaticLayout: true,
        minimap: {
            enabled: true
        },
        fontSize: 14,
        tabSize: 4,
        insertSpaces: true,
        lineNumbers: 'on',
        roundedSelection: true,
        scrollBeyondLastLine: false,
        wordWrap: 'on',
        renderLineHighlight: 'all',
        folding: true,
        suggestOnTriggerCharacters: true
    });
    
    // Cursor position change event
    editor.onDidChangeCursorPosition(e => {
        document.querySelector('.editor-status div:first-child').textContent = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
    });
    
    // Content change event
    editor.onDidChangeModelContent(e => {
        document.querySelector('.editor-tab.active').classList.add('modified');
        document.querySelector('.editor-container').classList.add('editor-modified');
    });
    
    // Handle window resize
    window.addEventListener('resize', () => {
        editor.layout();
    });
    
    // Toggle terminal
    document.getElementById('toggleTerminalBtn').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelector('.editor-terminal').classList.toggle('open');
        editor.layout();
    });
    
    // Close terminal
    document.getElementById('closeTerminalBtn').addEventListener('click', function() {
        document.querySelector('.editor-terminal').classList.remove('open');
        editor.layout();
    });
    
    // Clear terminal
    document.getElementById('clearTerminalBtn').addEventListener('click', function() {
        document.getElementById('terminalContent').innerHTML = '';
    });
    
    // Toggle sidebar
    document.getElementById('toggleSidebarBtn').addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelector('.editor-sidebar').style.display = 
            document.querySelector('.editor-sidebar').style.display === 'none' ? 'flex' : 'none';
        editor.layout();
    });
    
    // Format code
    document.getElementById('formatCodeBtn').addEventListener('click', function(e) {
        e.preventDefault();
        editor.getAction('editor.action.formatDocument').run();
    });
    
    // Find/Replace
    document.getElementById('findReplaceBtn').addEventListener('click', function(e) {
        e.preventDefault();
        editor.getAction('actions.find').run();
    });
    
    // Save file
    document.getElementById('saveFileBtn').addEventListener('click', function() {
        // In a real implementation, this would save to the server
        document.querySelector('.editor-tab.active').classList.remove('modified');
        document.querySelector('.editor-container').classList.remove('editor-modified');
        
        // Show a toast notification
        showToast('File saved successfully!');
    });
    
    // Run file
    document.getElementById('runFileBtn').addEventListener('click', function() {
        // Open terminal if not already open
        document.querySelector('.editor-terminal').classList.add('open');
        editor.layout();
        
        // Get the active file name
        const fileName = document.querySelector('.editor-tab.active .editor-tab-name').textContent;
        
        // Add the run command to the terminal
        const terminalContent = document.getElementById('terminalContent');
        terminalContent.innerHTML += `<div>&gt;&gt;&gt; python ${fileName}</div>`;
        terminalContent.innerHTML += `<div>Running ${fileName}...</div>`;
        
        // Simulate output
        setTimeout(() => {
            terminalContent.innerHTML += `<div>Execution completed successfully.</div>`;
            terminalContent.innerHTML += `<div>&gt;&gt;&gt; _</div>`;
            terminalContent.scrollTop = terminalContent.scrollHeight;
        }, 1000);
        
        // Scroll to bottom
        terminalContent.scrollTop = terminalContent.scrollHeight;
    });
    
    // New file dialog
    document.getElementById('newFileBtn').addEventListener('click', function() {
        document.getElementById('newFileDialog').style.display = 'flex';
        document.getElementById('newFileName').focus();
    });
    
    // Cancel new file
    document.getElementById('cancelNewFileBtn').addEventListener('click', function() {
        document.getElementById('newFileDialog').style.display = 'none';
    });
    
    // Create new file
    document.getElementById('createNewFileBtn').addEventListener('click', function() {
        const fileName = document.getElementById('newFileName').value.trim();
        if (fileName) {
            // In a real implementation, this would create a file on the server
            
            // Add to file explorer (simplified for demo)
            const fileExplorer = document.querySelector('.folder-content');
            
            // Determine file icon
            let iconClass = 'file';
            let iconTag = 'fas fa-file';
            
            if (fileName.endsWith('.py')) {
                iconClass = 'python';
                iconTag = 'fab fa-python';
            } else if (fileName.endsWith('.js')) {
                iconClass = 'javascript';
                iconTag = 'fab fa-js';
            } else if (fileName.endsWith('.html')) {
                iconClass = 'html';
                iconTag = 'fab fa-html5';
            } else if (fileName.endsWith('.css')) {
                iconClass = 'css';
                iconTag = 'fab fa-css3-alt';
            } else if (fileName.endsWith('.json')) {
                iconClass = 'json';
                iconTag = 'fas fa-code';
            } else if (fileName.endsWith('.md')) {
                iconClass = 'markdown';
                iconTag = 'fab fa-markdown';
            }
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-icon ${iconClass}">
                    <i class="${iconTag}"></i>
                </div>
                <div class="file-name">${fileName}</div>
            `;
            
            fileExplorer.appendChild(fileItem);
            
            // Create a new tab
            createTab(fileName, iconClass, iconTag);
            
            // Close dialog
            document.getElementById('newFileDialog').style.display = 'none';
            document.getElementById('newFileName').value = '';
            
            // Show a toast notification
            showToast(`File "${fileName}" created successfully!`);
        }
    });
    
    // Create a new tab
    function createTab(fileName, iconClass, iconTag) {
        const tabsContainer = document.querySelector('.editor-tabs');
        
        // Remove active class from all tabs
        document.querySelectorAll('.editor-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Create new tab
        const newTab = document.createElement('div');
        newTab.className = 'editor-tab active';
        newTab.innerHTML = `
            <div class="editor-tab-icon">
                <i class="${iconTag}"></i>
            </div>
            <div class="editor-tab-name">${fileName}</div>
            <div class="editor-tab-modified"></div>
            <div class="editor-tab-close">
                <i class="fas fa-times"></i>
            </div>
        `;
        
        tabsContainer.appendChild(newTab);
        
        // Clear editor content
        editor.setValue('');
        
        // Add tab click handlers
        addTabEventListeners(newTab);
    }
    
    // Add event listeners to tabs
    function addTabEventListeners(tab) {
        // Tab click
        tab.addEventListener('click', function(e) {
            if (!e.target.closest('.editor-tab-close')) {
                document.querySelectorAll('.editor-tab').forEach(t => {
                    t.classList.remove('active');
                });
                tab.classList.add('active');
                
                // In a real implementation, this would load the file content
            }
        });
        
        // Close tab
        const closeBtn = tab.querySelector('.editor-tab-close');
        closeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            
            if (tab.classList.contains('modified')) {
                if (!confirm('This file has unsaved changes. Are you sure you want to close it?')) {
                    return;
                }
            }
            
            // If this is the active tab, activate another one
            if (tab.classList.contains('active') && document.querySelectorAll('.editor-tab').length > 1) {
                const nextTab = tab.nextElementSibling || tab.previousElementSibling;
                if (nextTab) {
                    nextTab.classList.add('active');
                }
            }
            
            // Remove the tab
            tab.remove();
        });
    }
    
    // Add event listeners to existing tabs
    document.querySelectorAll('.editor-tab').forEach(tab => {
        addTabEventListeners(tab);
    });
    
    // Toggle folder expansion
    document.querySelectorAll('.folder-header').forEach(folderHeader => {
        folderHeader.addEventListener('click', function() {
            const folderItem = this.closest('.folder-item');
            folderItem.classList.toggle('folder-expanded');
            folderItem.classList.toggle('folder-collapsed');
        });
    });
    
    // File item click
    document.querySelectorAll('.file-item').forEach(fileItem => {
        fileItem.addEventListener('click', function() {
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            this.classList.add('active');
            
            // Get file name and update tab
            const fileName = this.querySelector('.file-name').textContent;
            let iconClass = 'file';
            let iconTag = 'fas fa-file';
            
            const fileIcon = this.querySelector('.file-icon');
            if (fileIcon.classList.contains('python')) {
                iconClass = 'python';
                iconTag = 'fab fa-python';
            } else if (fileIcon.classList.contains('javascript')) {
                iconClass = 'javascript';
                iconTag = 'fab fa-js';
            } else if (fileIcon.classList.contains('html')) {
                iconClass = 'html';
                iconTag = 'fab fa-html5';
            } else if (fileIcon.classList.contains('css')) {
                iconClass = 'css';
                iconTag = 'fab fa-css3-alt';
            }
            
            // Check if tab already exists
            let existingTab = null;
            document.querySelectorAll('.editor-tab').forEach(tab => {
                if (tab.querySelector('.editor-tab-name').textContent === fileName) {
                    existingTab = tab;
                }
            });
            
            if (existingTab) {
                // Activate existing tab
                document.querySelectorAll('.editor-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                existingTab.classList.add('active');
            } else {
                // Create new tab
                createTab(fileName, iconClass, iconTag);
            }
            
            // In a real implementation, this would load the file content
            if (fileName === 'main.py') {
                editor.setValue(`from app import app

if __name__ == "__main__":
    app.run(debug=True, host="0.0.0.0", port=5000)
`);
                editor.updateOptions({ language: 'python' });
            } else if (fileName === 'advanced_memory_system.py') {
                editor.setValue(`class AdvancedMemorySystem:
    """
    Advanced Memory System for Synapse Chamber
    
    Implements sophisticated memory storage and retrieval mechanisms including:
    - Semantic search across stored conversations and threads
    - Long-term and short-term memory storage
    - Context-aware memory retrieval
    - Memory consolidation and knowledge extraction
    - Distributed storage with PostgreSQL for structured data and vector store for embeddings
    """
    
    def __init__(self, memory_system=None):
        self.memory_system = memory_system
        self._init_memory_system()
        
    def _init_memory_system(self):
        """Initialize the memory system components"""
        self._init_database()
        self._init_semantic_index()
        self._load_cached_data()
        
    def _init_database(self):
        """Initialize database connection"""
        # Implementation details
        pass
        
    def store_memory(self, content, memory_type='general', metadata=None, source=None, importance=0.5, expiry=None):
        """
        Store a new memory item
        
        Args:
            content (str): The content of the memory
            memory_type (str): Type of memory (general, conversation, factual, procedural)
            metadata (dict): Additional metadata about the memory
            source (str): Source of the memory (user, system, platform name)
            importance (float): Importance score (0.0-1.0) for prioritization
            expiry (datetime): When the memory should expire (None for no expiry)
            
        Returns:
            int: ID of the stored memory item, or None if failed
        """
        # Implementation details
        pass
        
    def retrieve_memory(self, query, memory_type=None, limit=5, min_similarity=0.3):
        """
        Retrieve memories semantically similar to the query
        
        Args:
            query (str): The query text to match against memories
            memory_type (str, optional): Filter by memory type
            limit (int): Maximum number of results to return
            min_similarity (float): Minimum similarity score (0.0-1.0)
            
        Returns:
            list: Matching memory items with similarity scores
        """
        # Implementation details
        pass`);
                editor.updateOptions({ language: 'python' });
            } else if (fileName === 'layout.html') {
                editor.setValue(`<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Synapse Chamber{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Synapse Chamber" width="30" height="30" class="d-inline-block align-text-top me-2">
                Synapse Chamber
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <!-- Navigation Items -->
                </ul>
                
                <div class="d-flex">
                    <!-- User menu or other actions -->
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="py-4">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>`);
                editor.updateOptions({ language: 'html' });
            } else {
                // Default to empty file for other files
                editor.setValue('');
                
                // Set language based on file extension
                if (fileName.endsWith('.py')) {
                    editor.updateOptions({ language: 'python' });
                } else if (fileName.endsWith('.js')) {
                    editor.updateOptions({ language: 'javascript' });
                } else if (fileName.endsWith('.html')) {
                    editor.updateOptions({ language: 'html' });
                } else if (fileName.endsWith('.css')) {
                    editor.updateOptions({ language: 'css' });
                } else if (fileName.endsWith('.json')) {
                    editor.updateOptions({ language: 'json' });
                } else if (fileName.endsWith('.md')) {
                    editor.updateOptions({ language: 'markdown' });
                } else {
                    editor.updateOptions({ language: 'plaintext' });
                }
            }
        });
    });
    
    // Handle context menu
    const contextMenu = document.getElementById('contextMenu');
    let contextTarget = null;
    
    // Show context menu
    window.addEventListener('contextmenu', function(e) {
        if (e.target.closest('.file-explorer')) {
            e.preventDefault();
            contextTarget = e.target.closest('.file-item') || e.target.closest('.folder-item') || e.target.closest('.file-explorer');
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            
            // Ensure context menu doesn't go off screen
            const rect = contextMenu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                contextMenu.style.left = (e.pageX - rect.width) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                contextMenu.style.top = (e.pageY - rect.height) + 'px';
            }
        }
    });
    
    // Hide context menu on click outside
    window.addEventListener('click', function() {
        contextMenu.style.display = 'none';
        contextTarget = null;
    });
    
    // Prevent hiding when clicking inside context menu
    contextMenu.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    // Context menu actions
    document.getElementById('contextMenuNewFile').addEventListener('click', function() {
        document.getElementById('newFileDialog').style.display = 'flex';
        document.getElementById('newFileName').focus();
    });
    
    document.getElementById('contextMenuDelete').addEventListener('click', function() {
        if (contextTarget) {
            if (confirm('Are you sure you want to delete this item?')) {
                contextTarget.remove();
                showToast('Item deleted successfully!');
            }
        }
    });
    
    // Show toast notification
    function showToast(message) {
        // Create toast container if it doesn't exist
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = '1050';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast
        const toastId = 'toast-' + Date.now();
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = 'toast bg-dark';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
            <div class="toast-header bg-primary text-white">
                <strong class="me-auto">Editor</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Show toast
        const bsToast = new bootstrap.Toast(toast, {
            delay: 3000
        });
        bsToast.show();
        
        // Remove toast from DOM after hiding
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
    
    // Initialize key editor shortcuts
    window.addEventListener('keydown', function(e) {
        // Ctrl+S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            document.getElementById('saveFileBtn').click();
        }
        
        // Ctrl+N for new file
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            document.getElementById('newFileBtn').click();
        }
        
        // F5 to run
        if (e.key === 'F5') {
            e.preventDefault();
            document.getElementById('runFileBtn').click();
        }
        
        // Ctrl+` to toggle terminal
        if ((e.ctrlKey || e.metaKey) && e.key === '`') {
            e.preventDefault();
            document.getElementById('toggleTerminalBtn').click();
        }
    });
});
</script>
{% endblock %}