{% extends 'layout.html' %}

{% block title %}Memory Explorer - Synapse Chamber{% endblock %}

{% block styles %}
<style>
    .memory-item {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        background-color: rgba(35, 45, 60, 0.5);
        border: 1px solid rgba(35, 45, 60, 0.8);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .memory-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .memory-type {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 15px;
        font-size: 0.85rem;
        background-color: rgba(13, 110, 253, 0.2);
        color: #0d6efd;
        margin-right: 10px;
    }
    
    .memory-type.factual {
        background-color: rgba(13, 202, 240, 0.2);
        color: #0dcaf0;
    }
    
    .memory-type.procedural {
        background-color: rgba(108, 117, 125, 0.2);
        color: #6c757d;
    }
    
    .memory-type.conversation {
        background-color: rgba(111, 66, 193, 0.2);
        color: #6f42c1;
    }
    
    #memoryVisualization {
        width: 100%;
        height: 400px;
    }
    
    .stats-card {
        text-align: center;
        padding: 20px;
        background-color: rgba(35, 45, 60, 0.5);
        border-radius: 5px;
        transition: transform 0.2s;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        background: linear-gradient(45deg, #0d6efd, #6610f2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Memory Explorer</h1>
        <div>
            <button type="button" class="btn btn-primary me-2" id="syncMemoryBtn">
                <i class="fas fa-sync"></i> Sync Memory
            </button>
            <button type="button" class="btn btn-outline-secondary" id="settingsBtn">
                <i class="fas fa-cog"></i> Settings
            </button>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card mb-4">
                <div class="stats-number">{{ memory_stats.total_memories|default('0') }}</div>
                <div class="stats-label">Total Memories</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card mb-4">
                <div class="stats-number">{{ memory_stats.consolidated_knowledge|default('0') }}</div>
                <div class="stats-label">Knowledge Items</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card mb-4">
                <div class="stats-number">{{ memory_stats.contexts|default([])|length }}</div>
                <div class="stats-label">Active Contexts</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card mb-4">
                <div class="stats-number">{{ memory_stats.links|default('0') }}</div>
                <div class="stats-label">Memory Links</div>
            </div>
        </div>
    </div>
    
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-header bg-dark border-secondary">
            <h5 class="mb-0">Memory Search</h5>
        </div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="text" class="form-control bg-dark text-light" placeholder="Search memories..." id="memorySearchInput">
                <button class="btn btn-primary" type="button" id="memorySearchBtn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <div class="memory-filters d-flex flex-wrap mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="typeGeneral" checked>
                    <label class="form-check-label" for="typeGeneral">General</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="typeConversation" checked>
                    <label class="form-check-label" for="typeConversation">Conversation</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="typeFactual" checked>
                    <label class="form-check-label" for="typeFactual">Factual</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="typeProcedural" checked>
                    <label class="form-check-label" for="typeProcedural">Procedural</label>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-dark border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Memories</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-secondary active" id="listViewBtn">
                            <i class="fas fa-list"></i> List
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="networkViewBtn">
                            <i class="fas fa-project-diagram"></i> Network
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="memoriesList">
                        {% if memory_stats.recent_memories %}
                            {% for memory in memory_stats.recent_memories %}
                                <div class="memory-item">
                                    <span class="memory-type {{ memory.memory_type }}">{{ memory.memory_type|capitalize }}</span>
                                    <small class="text-muted ms-2">{{ memory.created_at }}</small>
                                    <p class="mb-0 mt-2">{{ memory.content }}</p>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-brain fa-3x text-muted"></i>
                                </div>
                                <p class="text-muted">No memories found</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div id="memoryVisualization" style="display: none;" class="my-3 border border-secondary rounded">
                        <!-- Memory network visualization will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-dark border-secondary">
                    <h5 class="mb-0">Memory Contexts</h5>
                </div>
                <div class="card-body">
                    {% if memory_stats.contexts %}
                        {% for context in memory_stats.contexts %}
                            <div class="mb-3">
                                <strong>{{ context.name }}</strong>
                                <pre class="bg-dark mt-2 p-2 rounded">{{ context.data|tojson(indent=2) }}</pre>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">No active memory contexts</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-dark border-secondary">
                    <h5 class="mb-0">Consolidated Knowledge</h5>
                </div>
                <div class="card-body">
                    <div class="text-center py-4">
                        <p class="text-muted">Consolidated knowledge will appear here as memories are processed and connected</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.4/dist/d3.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View toggle buttons
    const listViewBtn = document.getElementById('listViewBtn');
    const networkViewBtn = document.getElementById('networkViewBtn');
    const memoriesList = document.getElementById('memoriesList');
    const memoryVisualization = document.getElementById('memoryVisualization');
    
    // Memory search
    const memorySearchInput = document.getElementById('memorySearchInput');
    const memorySearchBtn = document.getElementById('memorySearchBtn');
    
    // Sync button
    const syncMemoryBtn = document.getElementById('syncMemoryBtn');
    
    // Set up view toggles
    if (listViewBtn && networkViewBtn) {
        listViewBtn.addEventListener('click', function() {
            listViewBtn.classList.add('active');
            networkViewBtn.classList.remove('active');
            memoriesList.style.display = 'block';
            memoryVisualization.style.display = 'none';
        });
        
        networkViewBtn.addEventListener('click', function() {
            networkViewBtn.classList.add('active');
            listViewBtn.classList.remove('active');
            memoriesList.style.display = 'none';
            memoryVisualization.style.display = 'block';
            
            // Initialize network visualization when toggled
            initializeVisualization();
        });
    }
    
    // Set up memory search
    if (memorySearchBtn) {
        memorySearchBtn.addEventListener('click', function() {
            const searchTerm = memorySearchInput.value.trim();
            if (searchTerm) {
                searchMemories(searchTerm);
            }
        });
    }
    
    if (memorySearchInput) {
        memorySearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = memorySearchInput.value.trim();
                if (searchTerm) {
                    searchMemories(searchTerm);
                }
            }
        });
    }
    
    // Set up sync button
    if (syncMemoryBtn) {
        syncMemoryBtn.addEventListener('click', function() {
            syncMemoryBtn.disabled = true;
            syncMemoryBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Syncing...';
            
            // In a real implementation, this would call an API endpoint
            // For now, simulate success
            setTimeout(function() {
                syncMemoryBtn.disabled = false;
                syncMemoryBtn.innerHTML = '<i class="fas fa-sync"></i> Sync Memory';
                
                // Show notification
                if (typeof showNotification === 'function') {
                    showNotification('success', 'Memory synchronized successfully');
                }
            }, 1500);
        });
    }
    
    function searchMemories(term) {
        // In a real implementation, this would call an API endpoint
        // For now, show a notification
        if (typeof showNotification === 'function') {
            showNotification('info', `Searching for: ${term}`);
        }
    }
    
    function initializeVisualization() {
        // Check if D3 is available
        if (typeof d3 === 'undefined') {
            console.error('D3 library not loaded');
            return;
        }
        
        // Clear previous visualization
        d3.select('#memoryVisualization').html('');
        
        // Create SVG container
        const svg = d3.select('#memoryVisualization')
            .append('svg')
            .attr('width', '100%')
            .attr('height', '100%')
            .attr('viewBox', [0, 0, 600, 400]);
        
        // Create sample data
        const nodes = [];
        const links = [];
        
        // Add some sample nodes
        for (let i = 0; i < 20; i++) {
            nodes.push({
                id: i,
                type: ['general', 'conversation', 'factual', 'procedural'][Math.floor(Math.random() * 4)],
                radius: Math.random() * 5 + 5
            });
        }
        
        // Add some sample links
        for (let i = 0; i < 30; i++) {
            const source = Math.floor(Math.random() * 20);
            const target = Math.floor(Math.random() * 20);
            
            // Avoid self-links
            if (source !== target) {
                links.push({
                    source,
                    target,
                    value: Math.random() * 2 + 1
                });
            }
        }
        
        // Create force simulation
        const simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(d => d.id).distance(50))
            .force('charge', d3.forceManyBody().strength(-30))
            .force('center', d3.forceCenter(300, 200));
        
        // Add the links
        const link = svg.append('g')
            .selectAll('line')
            .data(links)
            .join('line')
            .attr('stroke', '#999')
            .attr('stroke-opacity', 0.6)
            .attr('stroke-width', d => Math.sqrt(d.value));
        
        // Add the nodes
        const node = svg.append('g')
            .selectAll('circle')
            .data(nodes)
            .join('circle')
            .attr('r', d => d.radius)
            .attr('fill', d => {
                switch (d.type) {
                    case 'general': return '#0d6efd';
                    case 'conversation': return '#6f42c1';
                    case 'factual': return '#0dcaf0';
                    case 'procedural': return '#6c757d';
                    default: return '#0d6efd';
                }
            })
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));
        
        // Add tooltips
        node.append('title')
            .text(d => `Memory ${d.id} (${d.type})`);
        
        // Update the positions on tick
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
            
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
        });
        
        // Drag functions
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
    }
});
</script>
{% endblock %}
