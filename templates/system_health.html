{% extends 'layout.html' %}

{% block title %}System Health | Synapse Chamber{% endblock %}

{% block styles %}
<style>
    .status-card {
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .status-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .status-indicator {
        height: 12px;
        width: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .status-healthy {
        background-color: var(--bs-success);
    }
    
    .status-warning {
        background-color: var(--bs-warning);
    }
    
    .status-critical {
        background-color: var(--bs-danger);
    }
    
    .log-entry {
        border-left: 4px solid var(--bs-dark);
        padding-left: 10px;
        margin-bottom: 10px;
    }
    
    .log-entry.log-info {
        border-left-color: var(--bs-info);
    }
    
    .log-entry.log-warning {
        border-left-color: var(--bs-warning);
    }
    
    .log-entry.log-error {
        border-left-color: var(--bs-danger);
    }
    
    .metric-value {
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: var(--bs-secondary);
    }
    
    .refresh-btn {
        position: absolute;
        top: 10px;
        right: 10px;
    }
    
    .component-card {
        height: 100%;
    }
    
    .card-metrics {
        font-size: 0.85rem;
    }
    
    .chart-container {
        position: relative;
        height: 250px;
        width: 100%;
    }
    
    .platform-badge {
        font-size: 0.8rem;
        margin-right: 5px;
    }
    
    .platform-status {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .platform-name {
        width: 100px;
        font-weight: bold;
    }
    
    .platform-metrics {
        font-size: 0.8rem;
        color: var(--bs-secondary);
    }
    
    .action-btn {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-heartbeat me-2"></i> System Health Dashboard</h1>
        <button id="refreshBtn" class="btn btn-outline-primary">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
    
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div id="systemStatusCard" class="card bg-dark status-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span id="systemStatusIndicator" class="status-indicator"></span>
                        System Status
                    </h5>
                    <div class="d-flex flex-column">
                        <div class="metric-value" id="cpuUsage">--</div>
                        <div class="metric-label">CPU Usage</div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="lastUpdated">Last updated: --</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div id="memoryStatusCard" class="card bg-dark status-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span id="memoryStatusIndicator" class="status-indicator"></span>
                        Memory
                    </h5>
                    <div class="d-flex flex-column">
                        <div class="metric-value" id="memoryUsage">--</div>
                        <div class="metric-label">Memory Usage</div>
                    </div>
                    <div class="progress mt-2" style="height: 8px;">
                        <div id="memoryProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="memoryDetails">--</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div id="browserStatusCard" class="card bg-dark status-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span id="browserStatusIndicator" class="status-indicator"></span>
                        Browser Driver
                    </h5>
                    <div class="d-flex flex-column">
                        <div class="metric-value" id="browserStatus">--</div>
                        <div class="metric-label">Driver Status</div>
                    </div>
                    <div class="mt-2">
                        <button id="reinitializeDriverBtn" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-redo"></i> Reinitialize Driver
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div id="databaseStatusCard" class="card bg-dark status-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <span id="databaseStatusIndicator" class="status-indicator"></span>
                        Database
                    </h5>
                    <div class="d-flex flex-column">
                        <div class="metric-value" id="databaseConnectionStatus">--</div>
                        <div class="metric-label">Database Connection</div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="databasePoolStats">--</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card bg-dark status-card">
                <div class="card-header">
                    <h5 class="mb-0">Performance History</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="performanceChartTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="response-time-tab" data-bs-toggle="tab" data-bs-target="#response-time" type="button" role="tab">Response Time</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="error-rate-tab" data-bs-toggle="tab" data-bs-target="#error-rate" type="button" role="tab">Error Rate</button>
                        </li>
                    </ul>
                    <div class="tab-content py-3" id="performanceChartTabContent">
                        <div class="tab-pane fade show active" id="response-time" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="responseTimeChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="error-rate" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="errorRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card bg-dark status-card">
                <div class="card-header">
                    <h5 class="mb-0">System Load</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>1m Load Average</span>
                            <span id="load1m">--</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="load1mBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>5m Load Average</span>
                            <span id="load5m">--</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="load5mBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>15m Load Average</span>
                            <span id="load15m">--</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="load15mBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span>System Uptime</span>
                            <span id="uptime">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card bg-dark status-card">
                <div class="card-header">
                    <h5 class="mb-0">AI Platform Status</h5>
                </div>
                <div class="card-body" id="aiPlatformsContainer">
                    <div class="text-center">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card bg-dark status-card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Logs</h5>
                </div>
                <div class="card-body">
                    <div id="logsContainer" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center">
                            <div class="spinner-border text-secondary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
    // Global chart references
    let responseTimeChart = null;
    let errorRateChart = null;
    
    // Chart color customization
    const chartColors = {
        background: 'rgba(54, 162, 235, 0.2)',
        border: 'rgba(54, 162, 235, 1)',
        errorBackground: 'rgba(255, 99, 132, 0.2)',
        errorBorder: 'rgba(255, 99, 132, 1)',
        gridLines: 'rgba(255, 255, 255, 0.1)'
    };
    
    // Status class mapping
    const statusClasses = {
        healthy: 'status-healthy',
        warning: 'status-warning',
        critical: 'status-critical'
    };
    
    // Initialize the system health dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize error handler
        if (typeof SynapseErrorHandler !== 'undefined') {
            const errorHandler = new SynapseErrorHandler();
            errorHandler.init();
        }
        
        // Initialize tooltips
        if (typeof SynapseTooltips !== 'undefined') {
            const tooltips = new SynapseTooltips();
            tooltips.init();
        }
        
        // Initialize charts
        initCharts();
        
        // Load initial data
        loadSystemHealthData();
        
        // Setup refresh button
        document.getElementById('refreshBtn').addEventListener('click', function() {
            loadSystemHealthData();
        });
        
        // Setup reinitialize driver button
        document.getElementById('reinitializeDriverBtn').addEventListener('click', function() {
            reinitializeBrowserDriver();
        });
        
        // Auto-refresh every 60 seconds
        setInterval(loadSystemHealthData, 60000);
    });
    
    // Initialize charts
    function initCharts() {
        // Response time chart
        const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
        responseTimeChart = new Chart(responseTimeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Response Time (ms)',
                    data: [],
                    backgroundColor: chartColors.background,
                    borderColor: chartColors.border,
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#fff'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: chartColors.gridLines
                        },
                        ticks: {
                            color: '#fff'
                        }
                    },
                    x: {
                        grid: {
                            color: chartColors.gridLines
                        },
                        ticks: {
                            color: '#fff'
                        }
                    }
                }
            }
        });
        
        // Error rate chart
        const errorRateCtx = document.getElementById('errorRateChart').getContext('2d');
        errorRateChart = new Chart(errorRateCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Error Rate (%)',
                    data: [],
                    backgroundColor: chartColors.errorBackground,
                    borderColor: chartColors.errorBorder,
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#fff'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: chartColors.gridLines
                        },
                        ticks: {
                            color: '#fff'
                        }
                    },
                    x: {
                        grid: {
                            color: chartColors.gridLines
                        },
                        ticks: {
                            color: '#fff'
                        }
                    }
                }
            }
        });
    }
    
    // Load system health data
    function loadSystemHealthData() {
        // Display loading spinner or message
        document.getElementById('refreshBtn').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        document.getElementById('refreshBtn').disabled = true;
        
        fetch('/api/system-health/data')
            .then(response => response.json())
            .then(data => {
                updateSystemStatusDisplay(data);
                updateComponentCards(data);
                updateCharts(data);
                updateAiPlatforms(data);
                fetchSystemLogs();
                
                document.getElementById('refreshBtn').innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                document.getElementById('refreshBtn').disabled = false;
                
                console.log('System health data loaded successfully');
            })
            .catch(error => {
                console.error('Error loading system health data:', error);
                document.getElementById('refreshBtn').innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                document.getElementById('refreshBtn').disabled = false;
                
                if (typeof SynapseErrorHandler !== 'undefined') {
                    SynapseErrorHandler.showError({
                        type: 'error',
                        message: 'Failed to load system health data',
                        details: error.message,
                        container: document.querySelector('.container-fluid')
                    });
                } else {
                    alert('Failed to load system health data: ' + error.message);
                }
            });
    }
    
    // Update system status display
    function updateSystemStatusDisplay(data) {
        // Format timestamp
        const timestamp = new Date(data.timestamp);
        const formattedTime = timestamp.toLocaleTimeString();
        
        // Update last updated timestamp
        document.getElementById('lastUpdated').textContent = 'Last updated: ' + formattedTime;
        
        // Update CPU usage
        const cpuUsage = data.components.system.metrics.cpu_usage_percent.toFixed(1) + '%';
        document.getElementById('cpuUsage').textContent = cpuUsage;
        
        // Update status indicators
        updateStatusIndicator('systemStatusIndicator', data.overall_status);
        updateStatusIndicator('memoryStatusIndicator', data.components.memory.status);
        updateStatusIndicator('browserStatusIndicator', data.components.browser.status);
        updateStatusIndicator('databaseStatusIndicator', data.components.database.status);
        
        // Update status card colors
        updateStatusCardColor('systemStatusCard', data.overall_status);
        updateStatusCardColor('memoryStatusCard', data.components.memory.status);
        updateStatusCardColor('browserStatusCard', data.components.browser.status);
        updateStatusCardColor('databaseStatusCard', data.components.database.status);
    }
    
    // Update component cards
    function updateComponentCards(data) {
        // Update memory card
        const memUsage = data.components.memory.metrics.usage_percent.toFixed(1) + '%';
        document.getElementById('memoryUsage').textContent = memUsage;
        
        const memDetails = `${(data.components.memory.metrics.used_mb / 1024).toFixed(2)} GB / ${(data.components.memory.metrics.total_mb / 1024).toFixed(2)} GB`;
        document.getElementById('memoryDetails').textContent = memDetails;
        
        const memProgressBar = document.getElementById('memoryProgressBar');
        memProgressBar.style.width = data.components.memory.metrics.usage_percent + '%';
        
        if (data.components.memory.status === 'critical') {
            memProgressBar.className = 'progress-bar bg-danger';
        } else if (data.components.memory.status === 'warning') {
            memProgressBar.className = 'progress-bar bg-warning';
        } else {
            memProgressBar.className = 'progress-bar bg-success';
        }
        
        // Update browser card
        if (data.components.browser.metrics.initialized) {
            document.getElementById('browserStatus').textContent = 'Connected';
        } else {
            document.getElementById('browserStatus').textContent = 'Disconnected';
        }
        
        // Update database card
        if (data.components.database.metrics.connected) {
            document.getElementById('databaseConnectionStatus').textContent = 'Connected';
            
            const poolStats = `Pool size: ${data.components.database.metrics.pool_size}, In use: ${data.components.database.metrics.pool_checked_out}`;
            document.getElementById('databasePoolStats').textContent = poolStats;
        } else {
            document.getElementById('databaseConnectionStatus').textContent = 'Disconnected';
            document.getElementById('databasePoolStats').textContent = data.components.database.metrics.error || 'Connection error';
        }
        
        // Update load averages
        const load1m = data.components.system.metrics.load_avg_1m.toFixed(2);
        const load5m = data.components.system.metrics.load_avg_5m.toFixed(2);
        const load15m = data.components.system.metrics.load_avg_15m.toFixed(2);
        
        document.getElementById('load1m').textContent = load1m;
        document.getElementById('load5m').textContent = load5m;
        document.getElementById('load15m').textContent = load15m;
        
        const maxLoad = 4; // Assuming 4 cores as a reference
        document.getElementById('load1mBar').style.width = Math.min(100, (load1m / maxLoad) * 100) + '%';
        document.getElementById('load5mBar').style.width = Math.min(100, (load5m / maxLoad) * 100) + '%';
        document.getElementById('load15mBar').style.width = Math.min(100, (load15m / maxLoad) * 100) + '%';
        
        // Update uptime
        const uptime = formatUptime(data.components.system.metrics.uptime_seconds);
        document.getElementById('uptime').textContent = uptime;
    }
    
    // Update charts
    function updateCharts(data) {
        if (data.performance_history) {
            // Update response time chart
            responseTimeChart.data.labels = data.performance_history.timestamps;
            responseTimeChart.data.datasets[0].data = data.performance_history.response_time_ms;
            responseTimeChart.update();
            
            // Update error rate chart
            errorRateChart.data.labels = data.performance_history.timestamps;
            errorRateChart.data.datasets[0].data = data.performance_history.error_rate_percent;
            errorRateChart.update();
        }
    }
    
    // Update AI platforms display
    function updateAiPlatforms(data) {
        const container = document.getElementById('aiPlatformsContainer');
        container.innerHTML = '';
        
        if (data.components.ai && data.components.ai.platforms) {
            const platforms = data.components.ai.platforms;
            
            for (const [platformName, platformData] of Object.entries(platforms)) {
                const platformElement = document.createElement('div');
                platformElement.className = 'platform-status';
                
                const statusClass = statusClasses[platformData.status] || 'status-healthy';
                
                let lastSuccessText = 'N/A';
                if (platformData.last_success) {
                    const lastSuccess = new Date(platformData.last_success);
                    const minutesAgo = Math.round((new Date() - lastSuccess) / 60000);
                    lastSuccessText = `${minutesAgo} minutes ago`;
                }
                
                platformElement.innerHTML = `
                    <div class="platform-name text-capitalize">
                        <span class="status-indicator ${statusClass}"></span>${platformName}
                    </div>
                    <div class="platform-metrics me-2">
                        <div>Success: ${platformData.success_rate}%</div>
                        <div>Last: ${lastSuccessText}</div>
                    </div>
                    <div>
                        <span class="badge ${platformData.status === 'healthy' ? 'bg-success' : platformData.status === 'warning' ? 'bg-warning' : 'bg-danger'}">
                            ${platformData.status}
                        </span>
                    </div>
                `;
                
                container.appendChild(platformElement);
            }
        } else {
            container.innerHTML = '<div class="alert alert-secondary">No AI platform data available</div>';
        }
    }
    
    // Fetch system logs
    function fetchSystemLogs() {
        fetch('/api/system-health/logs')
            .then(response => response.json())
            .then(logs => {
                const logsContainer = document.getElementById('logsContainer');
                logsContainer.innerHTML = '';
                
                if (logs.length === 0) {
                    logsContainer.innerHTML = '<div class="alert alert-secondary">No logs available</div>';
                    return;
                }
                
                logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry log-${log.type}`;
                    
                    const timestamp = new Date(log.timestamp);
                    const formattedTime = timestamp.toLocaleTimeString();
                    
                    logEntry.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <strong>${log.type.toUpperCase()}</strong>
                            <small class="text-muted">${formattedTime}</small>
                        </div>
                        <div>${log.message}</div>
                    `;
                    
                    logsContainer.appendChild(logEntry);
                });
            })
            .catch(error => {
                console.error('Error fetching system logs:', error);
                document.getElementById('logsContainer').innerHTML = '<div class="alert alert-danger">Failed to load system logs</div>';
            });
    }
    
    // Reinitialize browser driver
    function reinitializeBrowserDriver() {
        const btn = document.getElementById('reinitializeDriverBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Reinitializing...';
        
        fetch('/api/system-health/reinitialize-driver', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('success', 'Browser driver reinitialized successfully');
                setTimeout(() => {
                    loadSystemHealthData();
                }, 1000);
            } else {
                showNotification('error', data.message || 'Failed to reinitialize browser driver');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-redo"></i> Reinitialize Driver';
        })
        .catch(error => {
            console.error('Error reinitializing browser driver:', error);
            showNotification('error', 'Failed to reinitialize browser driver');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-redo"></i> Reinitialize Driver';
        });
    }
    
    // Update status indicator
    function updateStatusIndicator(elementId, status) {
        const indicator = document.getElementById(elementId);
        indicator.className = 'status-indicator';
        
        const statusClass = statusClasses[status] || 'status-healthy';
        indicator.classList.add(statusClass);
    }
    
    // Update status card color
    function updateStatusCardColor(elementId, status) {
        const card = document.getElementById(elementId);
        
        // Reset card classes
        card.className = 'card bg-dark status-card';
        
        // Add border color based on status
        if (status === 'critical') {
            card.classList.add('border-danger');
        } else if (status === 'warning') {
            card.classList.add('border-warning');
        } else {
            card.classList.add('border-success');
        }
    }
    
    // Format uptime
    function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        
        let result = '';
        if (days > 0) {
            result += `${days}d `;
        }
        if (hours > 0 || days > 0) {
            result += `${hours}h `;
        }
        result += `${minutes}m`;
        
        return result;
    }
</script>
{% endblock %}