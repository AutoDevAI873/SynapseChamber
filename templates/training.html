{% extends 'layout.html' %}

{% block title %}Training - Synapse Chamber{% endblock %}

{% block content %}
<div class="container">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="mb-3">AutoDev Training Engine</h1>
      <p class="lead">Train AutoDev through multi-AI learning sessions that collect knowledge from various AI platforms.</p>
    </div>
  </div>

  <div class="row">
    <!-- Left column - Start Training Form -->
    <div class="col-lg-5 mb-4">
      <div class="card border-0 bg-dark">
        <div class="card-header bg-dark">
          <h5 class="card-title mb-0">Start New Training Session</h5>
        </div>
        <div class="card-body">
          <form id="training-form">
            <div class="mb-3">
              <label for="topic" class="form-label">Training Topic</label>
              <select class="form-select" id="topic" name="topic" required>
                <option value="" selected disabled>Select a topic...</option>
                {% for id, topic in topics.items() %}
                <option value="{{ id }}">{{ topic.name }}</option>
                {% endfor %}
              </select>
              <div class="form-text" id="topic-description"></div>
            </div>

            <div class="mb-3">
              <label for="mode" class="form-label">Training Mode</label>
              <select class="form-select" id="mode" name="mode" required>
                <option value="" selected disabled>Select a mode...</option>
                {% for mode in modes %}
                <option value="{{ mode }}">{{ mode|replace('_', ' ')|title }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Select how the training should be conducted.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">AI Platforms</label>
              <div class="row ps-2">
                <div class="col-sm-6 form-check">
                  <input class="form-check-input" type="checkbox" value="gpt" id="platform-gpt" name="platforms" checked>
                  <label class="form-check-label" for="platform-gpt">
                    ChatGPT
                  </label>
                </div>
                <div class="col-sm-6 form-check">
                  <input class="form-check-input" type="checkbox" value="claude" id="platform-claude" name="platforms" checked>
                  <label class="form-check-label" for="platform-claude">
                    Claude
                  </label>
                </div>
                <div class="col-sm-6 form-check">
                  <input class="form-check-input" type="checkbox" value="gemini" id="platform-gemini" name="platforms" checked>
                  <label class="form-check-label" for="platform-gemini">
                    Gemini
                  </label>
                </div>
                <div class="col-sm-6 form-check">
                  <input class="form-check-input" type="checkbox" value="deepseek" id="platform-deepseek" name="platforms">
                  <label class="form-check-label" for="platform-deepseek">
                    DeepSeek
                  </label>
                </div>
                <div class="col-sm-6 form-check">
                  <input class="form-check-input" type="checkbox" value="grok" id="platform-grok" name="platforms">
                  <label class="form-check-label" for="platform-grok">
                    Grok
                  </label>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="goal" class="form-label">Specific Goal (Optional)</label>
              <textarea class="form-control" id="goal" name="goal" rows="3" placeholder="Describe what you want to achieve with this training session..."></textarea>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary" id="start-training-btn">Start Training Session</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right column - Status & Logs -->
    <div class="col-lg-7">
      <!-- Current Session Status -->
      <div class="card border-0 bg-dark mb-4" id="current-session-card" style="display:none;">
        <div class="card-header bg-dark d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Current Training Session</h5>
          <span class="badge bg-primary" id="session-status">In Progress</span>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <p><strong>Topic:</strong> <span id="session-topic"></span></p>
            <p><strong>Mode:</strong> <span id="session-mode"></span></p>
            <p><strong>AI Platforms:</strong> <span id="session-platforms"></span></p>
          </div>
          <div class="progress mb-3" style="height: 20px;">
            <div class="progress-bar" id="session-progress" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
          </div>
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button class="btn btn-outline-info" id="view-details-btn">View Details</button>
            <button class="btn btn-outline-success" id="apply-training-btn" disabled>Apply to AutoDev</button>
          </div>
        </div>
      </div>

      <!-- Training Live Logs -->
      <div class="card border-0 bg-dark">
        <div class="card-header bg-dark d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Training Logs</h5>
          <button class="btn btn-sm btn-outline-secondary" id="clear-logs-btn">Clear</button>
        </div>
        <div class="card-body">
          <div class="training-logs mb-2" id="training-logs">
            <div class="text-muted text-center py-5">
              No active training session. Start a new training session to see logs.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Sessions History -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card border-0 bg-dark">
        <div class="card-header bg-dark">
          <h5 class="card-title mb-0">Training History</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Topic</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="training-history">
                {% if training_threads %}
                  {% for thread in training_threads %}
                  <tr>
                    <td>{{ thread.id }}</td>
                    <td>{{ thread.subject }}</td>
                    <td>{{ thread.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{% if thread.final_plan %}Completed{% else %}In Progress{% endif %}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-info view-thread-btn" data-thread-id="{{ thread.id }}">Details</button>
                      {% if thread.final_plan %}
                      <button class="btn btn-sm btn-outline-success apply-thread-btn" data-thread-id="{{ thread.id }}">Apply</button>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="5" class="text-center">No training sessions yet</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Training Session Details Modal -->
  <div class="modal fade" id="session-details-modal" tabindex="-1" aria-labelledby="sessionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark">
        <div class="modal-header">
          <h5 class="modal-title" id="sessionDetailsModalLabel">Training Session Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Session Information</h6>
              <dl class="row">
                <dt class="col-sm-4">Thread ID:</dt>
                <dd class="col-sm-8" id="detail-thread-id"></dd>
                <dt class="col-sm-4">Topic:</dt>
                <dd class="col-sm-8" id="detail-topic"></dd>
                <dt class="col-sm-4">Goal:</dt>
                <dd class="col-sm-8" id="detail-goal"></dd>
                <dt class="col-sm-4">Created:</dt>
                <dd class="col-sm-8" id="detail-created"></dd>
                <dt class="col-sm-4">Status:</dt>
                <dd class="col-sm-8" id="detail-status"></dd>
              </dl>
            </div>
            <div class="col-md-6">
              <h6>AI Contributions</h6>
              <div id="detail-contributions">
                <p class="text-muted">No AI contributions available</p>
              </div>
            </div>
          </div>
          <hr>
          <div class="row">
            <div class="col-12">
              <h6>Final Plan</h6>
              <div id="detail-final-plan" class="bg-dark border p-3 rounded">
                <p class="text-muted">No final plan available</p>
              </div>
            </div>
          </div>
          <hr>
          <div class="row">
            <div class="col-12">
              <h6>Associated Conversations</h6>
              <div class="table-responsive">
                <table class="table table-dark table-sm">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Platform</th>
                      <th>Created</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="detail-conversations">
                    <tr>
                      <td colspan="4" class="text-center">No conversations associated</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="modal-apply-btn">Apply to AutoDev</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Alert -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="success-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-success text-white">
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="success-message">
        Training session started successfully.
      </div>
    </div>
  </div>

  <!-- Error Alert -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="error-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header bg-danger text-white">
        <strong class="me-auto">Error</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="error-message">
        An error occurred while starting the training session.
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Store topic descriptions for the training.js script
  const topicSelectElement = document.getElementById('topic');
  if (topicSelectElement) {
    topicSelectElement.dataset.descriptions = JSON.stringify({
      {% for id, topic in topics.items() %}
      "{{ id }}": "{{ topic.description }}",
      {% endfor %}
    });
  }
</script>
<script src="{{ url_for('static', filename='js/training.js') }}"></script>
{% endblock %}